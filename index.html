<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Nexus Transport PR</title>

  <!-- CSS -->
  <link rel="stylesheet" href="styles.css"/>

  <!-- Firebase v8 (compatible con app.js) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- jsPDF (UMD) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>

<!-- ================= TOPBAR ================= -->
<header class="topbar" id="topbar" hidden>
  <div class="brand">
    <div class="logo">NT</div>
    <div>
      <div class="brandName" id="brandName">Nexus Transport PR</div>
      <div class="brandSub" id="whoLine">—</div>
    </div>
  </div>

  <div class="nav" id="navTabs">
    <button class="tab active" data-view="dashboard">Dashboard</button>
    <button class="tab" data-view="driver">Chofer</button>

    <button class="tab" id="tabAdminUsers" data-view="adminUsers">Usuarios</button>
    <button class="tab" id="tabAdminClients" data-view="adminClients">Clientes</button>
    <button class="tab" id="tabAdminServices" data-view="adminServices">Servicios</button>
    <button class="tab" id="tabAdminClose" data-view="adminClose">Cierre</button>
    <button class="tab" id="tabAdminInvoices" data-view="adminInvoices">Facturas</button>
    <button class="tab" id="tabAdminSettings" data-view="adminSettings">Settings</button>
  </div>

  <div class="actions">
    <span class="pill" id="rolePill">—</span>
    <button class="btn" id="btnReload">Recargar</button>
    <button class="btn danger" id="btnLogout">Salir</button>
  </div>
</header>

<!-- ================= APP ================= -->
<main class="container" id="app" hidden>

  <!-- ===== LOGIN ===== -->
  <section class="view active" id="view-login">
    <div class="card">
      <div class="cardHead">
        <h2>Acceso</h2>
        <span class="hint">Google + PIN</span>
      </div>

      <p id="loginMsg" class="muted">Inicia sesión con Google</p>

      <div class="bigActions">
        <button class="btnXL primary" id="btnGoogleLogin">Entrar con Google</button>
      </div>

      <div class="hr"></div>

      <div class="inline2">
        <div class="card subcard">
          <h3 style="margin:0 0 10px 0">Confirmar PIN</h3>
          <label class="muted" for="pinInput">PIN</label>
          <input id="pinInput" type="password" placeholder="••••"/>
          <div class="error" id="pinError"></div>
          <div class="actions" style="margin-top:10px">
            <button class="btn primary" id="btnPinConfirm">Entrar</button>
          </div>
        </div>

        <div class="card subcard">
          <h3 style="margin:0 0 10px 0">Crear PIN</h3>
          <label class="muted" for="pinNew">Nuevo PIN</label>
          <input id="pinNew" type="password" placeholder="Mínimo 4 dígitos"/>
          <label class="muted" for="pinNew2">Confirmar PIN</label>
          <input id="pinNew2" type="password" placeholder="Repite el PIN"/>
          <div class="error" id="pinSetError"></div>
          <div class="actions" style="margin-top:10px">
            <button class="btn" id="btnPinSet">Guardar PIN</button>
          </div>
        </div>
      </div>

      <p class="muted" style="margin-top:12px">
        Si tu email no está invitado, no entra. Aquí no hay “visitantes”.
      </p>
    </div>
  </section>

  <!-- ===== DASHBOARD ===== -->
  <section class="view" id="view-dashboard">

    <!-- QUICK ENTRY (CHOFER) -->
    <div class="card">
      <div class="cardHead">
        <h2>Entrada rápida (solo millas)</h2>
        <span class="hint" id="quickPreview">—</span>
      </div>

      <div class="formGrid">
        <label>
          Fecha
          <input type="date" id="qsDate"/>
        </label>

        <label>
          Cliente
          <select id="qsClient"></select>
        </label>

        <label>
          Millas
          <input type="number" id="qsMiles" step="0.1" placeholder="0.0"/>
        </label>

        <label>
          Nota (opcional)
          <input type="text" id="qsNote" placeholder="Ej: peaje / espera / ajuste"/>
        </label>
      </div>

      <div class="actions" style="margin-top:12px">
        <button class="btn primary" id="btnQuickSave">Guardar</button>
        <button class="btn" id="btnQuickClear">Limpiar</button>
      </div>
    </div>

    <!-- KPI -->
    <div class="grid2">
      <div class="card">
        <div class="kpiTitle">Semana</div>
        <div class="kpiSub" id="kpiWeekRange">—</div>
      </div>
      <div class="card">
        <div class="kpiTitle">Millas semana</div>
        <div class="kpiValue" id="kpiWeekMiles">0</div>
      </div>
      <div class="card">
        <div class="kpiTitle">Servicios</div>
        <div class="kpiValue" id="kpiWeekServices">0</div>
      </div>
      <div class="card">
        <div class="kpiTitle">Neto Chofer</div>
        <div class="kpiValue" id="kpiWeekDriverNet">$0.00</div>
      </div>
      <div class="card">
        <div class="kpiTitle">Empresa</div>
        <div class="kpiValue" id="kpiWeekCompany">$0.00</div>
      </div>
    </div>

    <!-- Recent -->
    <div class="card">
      <div class="cardHead">
        <h2>Últimos servicios</h2>
        <span class="hint">Admin puede borrar</span>
      </div>

      <div class="tableWrap">
        <table class="table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Cliente</th>
              <th class="num">Millas</th>
              <th class="num">Bruto</th>
              <th class="num">Neto chofer</th>
              <th class="num">Acción</th>
            </tr>
          </thead>
          <tbody id="dashRecent"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ===== DRIVER HISTORY ===== -->
  <section class="view" id="view-driver">
    <div class="card">
      <div class="cardHead">
        <h2>Historial Chofer</h2>
        <span class="hint">Por semanas o meses</span>
      </div>

      <div class="formRow">
        <input type="date" id="drvFrom"/>
        <input type="date" id="drvTo"/>
        <select id="drvGroup">
          <option value="none">Detalle</option>
          <option value="week">Por semana</option>
          <option value="month">Por mes</option>
        </select>
        <button class="btn primary" id="btnDrvFilter">Filtrar</button>
        <button class="btn" id="btnDrvPDF">PDF</button>
      </div>

      <div class="tableWrap">
        <table class="table">
          <thead id="drvHead"></thead>
          <tbody id="drvBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ===== ADMIN USERS ===== -->
  <section class="view" id="view-adminUsers">
    <div class="card">
      <div class="cardHead">
        <h2>Usuarios</h2>
        <span class="hint">Invitar por email + reset PIN</span>
      </div>

      <div class="formGrid">
        <label>
          Email
          <input id="uEmail" type="email" placeholder="chofer@correo.com"/>
        </label>
        <label>
          Rol
          <select id="uRole">
            <option value="driver">driver</option>
            <option value="admin">admin</option>
          </select>
        </label>
        <label>
          Activo
          <select id="uActive">
            <option value="true">Sí</option>
            <option value="false">No</option>
          </select>
        </label>
        <label class="full">
          Nota (opcional)
          <input id="uNote" type="text" placeholder="Ej: Turno noche / Camión #3"/>
        </label>
      </div>

      <div class="actions" style="margin-top:12px">
        <button class="btn primary" id="btnInviteUser">Guardar invitación</button>
        <button class="btn danger" id="btnResetPin">Reset PIN (seleccionado)</button>
      </div>

      <div class="hr"></div>

      <div class="tableWrap">
        <table class="table">
          <thead>
            <tr>
              <th>Email</th>
              <th>Rol</th>
              <th>Activo</th>
              <th>UID</th>
              <th>PIN</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="usersTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ===== ADMIN CLIENTS ===== -->
  <section class="view" id="view-adminClients">
    <div class="card">
      <div class="cardHead">
        <h2>Clientes</h2>
        <span class="hint">Dinámicos (tarifa por milla)</span>
      </div>

      <div class="formGrid">
        <label>
          Nombre
          <input id="cName" type="text" placeholder="Ej: Dealer XYZ"/>
        </label>
        <label>
          Tarifa (por milla)
          <input id="cRate" type="number" step="0.01" placeholder="1.00"/>
        </label>
        <label>
          ¿Connect?
          <select id="cConnect">
            <option value="no">No</option>
            <option value="yes">Sí</option>
          </select>
        </label>
        <label>
          Activo
          <select id="cActive">
            <option value="true">Sí</option>
            <option value="false">No</option>
          </select>
        </label>
      </div>

      <div class="actions" style="margin-top:12px">
        <button class="btn primary" id="btnSaveClient">Guardar cliente</button>
        <button class="btn" id="btnClearClient">Limpiar</button>
      </div>

      <div class="hr"></div>

      <div class="tableWrap">
        <table class="table">
          <thead>
            <tr>
              <th>Cliente</th>
              <th class="num">Tarifa</th>
              <th>Connect</th>
              <th>Activo</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="clientsTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ===== ADMIN SERVICES ===== -->
  <section class="view" id="view-adminServices">
    <div class="card">
      <div class="cardHead">
        <h2>Servicios</h2>
        <span class="hint">Filtro + CSV + borrar masivo</span>
      </div>

      <div class="filters">
        <label>
          Semana (lunes)
          <input type="date" id="sWeek"/>
        </label>
        <label>
          Chofer
          <select id="sDriver"></select>
        </label>
        <label>
          Cliente
          <select id="sClient"></select>
        </label>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnSvcFilter">Filtrar</button>
        <button class="btn" id="btnSvcCSV">Exportar CSV</button>
        <button class="btn danger" id="btnSvcDeleteMany">Borrar seleccionados</button>
      </div>

      <div class="hr"></div>

      <div class="tableWrap">
        <table class="table">
          <thead>
            <tr>
              <th></th>
              <th>Fecha</th>
              <th>Chofer</th>
              <th>Cliente</th>
              <th class="num">Millas</th>
              <th class="num">Bruto</th>
              <th class="num">Adj</th>
              <th class="num">Empresa</th>
              <th class="num">Retención</th>
              <th class="num">Neto</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="servicesTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ===== ADMIN CLOSE ===== -->
  <section class="view" id="view-adminClose">
    <div class="card">
      <div class="cardHead">
        <h2>Cierre semanal</h2>
        <span class="hint">Por chofer o todos</span>
      </div>

      <div class="filters">
        <label>
          Semana (lunes)
          <input type="date" id="wkStart"/>
        </label>
        <label>
          Chofer
          <select id="wkDriver"></select>
        </label>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnBuildWeekly">Generar</button>
        <button class="btn" id="btnWeeklyPDF">PDF</button>
      </div>

      <div class="hr"></div>

      <div class="invoice" id="weeklyBox">
        <div class="muted">Genera un cierre para ver el resumen aquí.</div>
      </div>
    </div>
  </section>

  <!-- ===== ADMIN INVOICES ===== -->
  <section class="view" id="view-adminInvoices">
    <div class="card">
      <div class="cardHead">
        <h2>Factura por cliente</h2>
        <span class="hint">Semana + cliente</span>
      </div>

      <div class="filters">
        <label>
          Semana (lunes)
          <input type="date" id="invWeek"/>
        </label>
        <label>
          Cliente
          <select id="invClient"></select>
        </label>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnBuildInvoice">Generar</button>
        <button class="btn" id="btnInvoicePDF">PDF</button>
      </div>

      <div class="hr"></div>

      <div class="invoice" id="invoiceBox">
        <div class="muted">Genera una factura para ver la vista previa aquí.</div>
      </div>
    </div>
  </section>

  <!-- ===== ADMIN SETTINGS ===== -->
  <section class="view" id="view-adminSettings">
    <div class="card">
      <div class="cardHead">
        <h2>Settings</h2>
        <span class="hint">Porcentajes + branding</span>
      </div>

      <div class="formGrid">
        <label class="full">
          Marca
          <input id="setBrand" type="text" placeholder="Nexus Transport PR"/>
        </label>

        <label>
          Connect % (0.15)
          <input id="setConnect" type="number" step="0.01"/>
        </label>

        <label>
          Empresa % (0.30)
          <input id="setCompany" type="number" step="0.01"/>
        </label>

        <label>
          Retención % (0.10)
          <input id="setRetention" type="number" step="0.01"/>
        </label>

        <label class="full">
          Footer (PDF)
          <input id="setFooter" type="text" placeholder="Resumen generado por Nexus Transport PR"/>
        </label>
      </div>

      <div class="actions" style="margin-top:12px">
        <button class="btn primary" id="btnSaveSettings">Guardar</button>
        <button class="btn danger" id="btnWipeCache">Limpiar cache local</button>
      </div>

      <p class="muted" style="margin-top:10px">
        Nota: solo Admin ve esta vista. Si un chofer entra aquí, es que las reglas están mal… y eso no va a pasar.
      </p>
    </div>
  </section>

</main>

<footer class="footer">
  © 2026 Nexus Transport PR
</footer>

<!-- APP (AL FINAL) -->
<script src="app.js"></script>

</body>
</html>
