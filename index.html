<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Nexus Transport PR</title>

  <link rel="stylesheet" href="styles.css"/>

  <!-- Firebase v8 (compatible con app.js) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>

<header class="topbar" id="topbar" hidden>
  <div class="brand">
    <div class="logo">NT</div>
    <div>
      <div class="brandName" id="brandName">Nexus Transport PR</div>
      <div class="brandSub">
        <span id="whoLine">—</span>
        <span class="dot">•</span>
        <span class="pill" id="rolePill">—</span>
      </div>
    </div>
  </div>

  <nav class="nav" id="navTabs">
    <button class="tab active" data-view="dashboard">Dashboard</button>
    <button class="tab" data-view="driver">Chofer</button>

    <button class="tab" id="tabAdminUsers" data-view="adminUsers">Usuarios</button>
    <button class="tab" id="tabAdminClients" data-view="adminClients">Clientes</button>
    <button class="tab" id="tabAdminServices" data-view="adminServices">Servicios</button>
    <button class="tab" id="tabAdminClose" data-view="adminClose">Cierre</button>
    <button class="tab" id="tabAdminInvoices" data-view="adminInvoices">Facturas</button>
    <button class="tab" id="tabAdminSettings" data-view="adminSettings">Settings</button>
  </nav>

  <div class="actions">
    <button class="btn" id="btnReload">Recargar</button>
    <button class="btn danger" id="btnLogout">Salir</button>
  </div>
</header>

<main class="container" id="app" hidden>

  <!-- ================= LOGIN ================= -->
  <section class="view active" id="view-login">
    <div class="card">
      <div class="cardHead">
        <h2>Acceso</h2>
        <div class="hint" id="loginMsg">Inicia sesión con Google</div>
      </div>

      <button class="btnXL primary" id="btnGoogleLogin">Entrar con Google</button>

      <div class="hr"></div>

      <div class="inline2">
        <div class="subcard card">
          <h3 class="h3">Confirmar PIN</h3>
          <label class="lbl">PIN</label>
          <input id="pinInput" type="password" inputmode="numeric" placeholder="••••" />
          <div class="error" id="pinError"></div>
          <button class="btn primary" id="btnPinConfirm">Confirmar PIN</button>
        </div>

        <div class="subcard card">
          <h3 class="h3">Crear PIN (primera vez)</h3>
          <label class="lbl">Nuevo PIN</label>
          <input id="pinNew" type="password" inputmode="numeric" placeholder="Mínimo 4 dígitos"/>
          <label class="lbl">Confirmar PIN</label>
          <input id="pinNew2" type="password" inputmode="numeric" placeholder="Repite el PIN"/>
          <div class="error" id="pinSetError"></div>
          <button class="btn" id="btnPinSet">Guardar PIN</button>
        </div>
      </div>

      <div class="hr"></div>
      <div class="muted">
        Nota operativa: el Admin debe invitar tu email antes de entrar.
      </div>
    </div>
  </section>

  <!-- ================= DASHBOARD ================= -->
  <section class="view" id="view-dashboard">

    <div class="grid2">
      <div class="card">
        <div class="kpiTitle" id="kpiWeekRange">Semana desde —</div>
        <div class="kpiValue" id="kpiWeekMiles">0.0</div>
        <div class="kpiSub">Millas (semana)</div>
      </div>

      <div class="card">
        <div class="kpiTitle">Servicios</div>
        <div class="kpiValue" id="kpiWeekServices">0</div>
        <div class="kpiSub">Registros (semana)</div>
      </div>

      <div class="card">
        <div class="kpiTitle">Neto Chofer</div>
        <div class="kpiValue" id="kpiWeekDriverNet">$0.00</div>
        <div class="kpiSub">Después % y retención</div>
      </div>

      <div class="card">
        <div class="kpiTitle">Empresa</div>
        <div class="kpiValue" id="kpiWeekCompany">$0.00</div>
        <div class="kpiSub">Participación semanal</div>
      </div>
    </div>

    <!-- Entrada rápida (lo que el chofer usa) -->
    <div class="card">
      <div class="cardHead">
        <h2>Entrada rápida (Chofer)</h2>
        <div class="hint" id="quickPreview">—</div>
      </div>

      <div class="formGrid">
        <label>Fecha
          <input type="date" id="qsDate"/>
        </label>

        <label>Cliente
          <select id="qsClient"></select>
        </label>

        <label>Millas
          <input id="qsMiles" type="number" step="0.1" inputmode="decimal" placeholder="Ej: 12.5"/>
        </label>

        <label>Nota (opcional)
          <input id="qsNote" placeholder="Ej: peaje, hotel, detalle..."/>
        </label>

        <div class="actions full">
          <button class="btn primary" id="btnQuickSave">Guardar servicio</button>
          <button class="btn" id="btnQuickClear">Limpiar</button>
        </div>

        <div class="muted full">
          Se guarda con anti-duplicado por: mismo chofer + mismo día + mismo cliente + mismas millas.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <h2>Últimos servicios (semana)</h2>
        <div class="hint">Admin puede borrar. Chofer solo ve.</div>
      </div>

      <div class="tableWrap">
        <table class="table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Cliente</th>
              <th class="num">Millas</th>
              <th class="num">Bruto</th>
              <th class="num">Neto Chofer</th>
              <th class="num">Acción</th>
            </tr>
          </thead>
          <tbody id="dashRecent"></tbody>
        </table>
      </div>
    </div>

  </section>

  <!-- ================= DRIVER (HISTORIAL) ================= -->
  <section class="view" id="view-driver">
    <div class="card">
      <div class="cardHead">
        <h2>Historial Chofer</h2>
        <div class="hint">Detalle / por semana / por mes + PDF</div>
      </div>

      <div class="formRow">
        <input type="date" id="drvFrom"/>
        <input type="date" id="drvTo"/>
        <select id="drvGroup">
          <option value="none">Detalle</option>
          <option value="week">Por semana</option>
          <option value="month">Por mes</option>
        </select>
        <button class="btn primary" id="btnDrvFilter">Filtrar</button>
        <button class="btn" id="btnDrvPDF">PDF</button>
      </div>

      <div class="tableWrap">
        <table class="table">
          <thead id="drvHead"></thead>
          <tbody id="drvBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ================= ADMIN USERS ================= -->
  <section class="view" id="view-adminUsers">
    <div class="card">
      <div class="cardHead">
        <h2>Usuarios (Admin)</h2>
        <div class="hint">Invitar email / roles / reset PIN</div>
      </div>

      <div class="formGrid">
        <label>Email
          <input id="uEmail" placeholder="correo@dominio.com"/>
        </label>

        <label>Rol
          <select id="uRole">
            <option value="driver">driver</option>
            <option value="admin">admin</option>
          </select>
        </label>

        <label>Activo
          <select id="uActive">
            <option value="true">Sí</option>
            <option value="false">No</option>
          </select>
        </label>

        <label>Nota
          <input id="uNote" placeholder="Opcional"/>
        </label>

        <div class="actions full">
          <button class="btn primary" id="btnInviteUser">Guardar invitación</button>
          <button class="btn danger" id="btnResetPin">Reset PIN (usuario seleccionado)</button>
        </div>

        <div class="muted full">Tip: haz clic en “Seleccionar” en la tabla para elegir un usuario a resetear.</div>
      </div>

      <div class="hr"></div>

      <div class="tableWrap">
        <table class="table">
          <thead>
            <tr>
              <th>Email</th><th>Rol</th><th>Activo</th><th>UID</th><th>PIN</th><th>Acción</th>
            </tr>
          </thead>
          <tbody id="usersTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ================= ADMIN CLIENTS ================= -->
  <section class="view" id="view-adminClients">
    <div class="card">
      <div class="cardHead">
        <h2>Clientes (Admin)</h2>
        <div class="hint">Dinámicos por tarifa (rate)</div>
      </div>

      <div class="formGrid">
        <label>Nombre
          <input id="cName" placeholder="Ej: Connect / AAA / Dealer"/>
        </label>

        <label>Tarifa por milla (rate)
          <input id="cRate" type="number" step="0.01" inputmode="decimal" placeholder="Ej: 4.25"/>
        </label>

        <label>Es Connect?
          <select id="cConnect">
            <option value="no">No</option>
            <option value="yes">Sí</option>
          </select>
        </label>

        <label>Activo
          <select id="cActive">
            <option value="true">Sí</option>
            <option value="false">No</option>
          </select>
        </label>

        <div class="actions full">
          <button class="btn primary" id="btnSaveClient">Guardar cliente</button>
          <button class="btn" id="btnClearClient">Nuevo</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="tableWrap">
        <table class="table">
          <thead>
            <tr><th>Cliente</th><th class="num">Rate</th><th>Connect</th><th>Activo</th><th>Acción</th></tr>
          </thead>
          <tbody id="clientsTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ================= ADMIN SERVICES ================= -->
  <section class="view" id="view-adminServices">
    <div class="card">
      <div class="cardHead">
        <h2>Servicios (Admin)</h2>
        <div class="hint">Filtrar / exportar CSV / borrar en lote</div>
      </div>

      <div class="filters">
        <label>Semana (lunes)
          <input type="date" id="sWeek"/>
        </label>
        <label>Chofer
          <select id="sDriver"></select>
        </label>
        <label>Cliente
          <select id="sClient"></select>
        </label>

        <div class="actions">
          <button class="btn primary" id="btnSvcFilter">Filtrar</button>
          <button class="btn" id="btnSvcCSV">CSV</button>
          <button class="btn danger" id="btnSvcDeleteMany">Borrar selección</button>
        </div>
      </div>

      <div class="tableWrap">
        <table class="table">
          <thead>
            <tr>
              <th></th>
              <th>Fecha</th>
              <th>Chofer</th>
              <th>Cliente</th>
              <th class="num">Millas</th>
              <th class="num">Bruto</th>
              <th class="num">Adj Connect</th>
              <th class="num">Empresa</th>
              <th class="num">Retención</th>
              <th class="num">Neto Chofer</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="servicesTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ================= ADMIN CLOSE ================= -->
  <section class="view" id="view-adminClose">
    <div class="card">
      <div class="cardHead">
        <h2>Cierre semanal (Admin)</h2>
        <div class="hint">Totales + PDF</div>
      </div>

      <div class="filters">
        <label>Semana (lunes)
          <input type="date" id="wkStart"/>
        </label>
        <label>Chofer (opcional)
          <select id="wkDriver"></select>
        </label>
        <div class="actions">
          <button class="btn primary" id="btnBuildWeekly">Construir</button>
          <button class="btn" id="btnWeeklyPDF">PDF</button>
        </div>
      </div>

      <div class="invoice" id="weeklyBox">
        <div class="muted">—</div>
      </div>
    </div>
  </section>

  <!-- ================= ADMIN INVOICES ================= -->
  <section class="view" id="view-adminInvoices">
    <div class="card">
      <div class="cardHead">
        <h2>Facturar por cliente (Admin)</h2>
        <div class="hint">Vista + PDF</div>
      </div>

      <div class="filters">
        <label>Semana (lunes)
          <input type="date" id="invWeek"/>
        </label>
        <label>Cliente
          <select id="invClient"></select>
        </label>
        <div class="actions">
          <button class="btn primary" id="btnBuildInvoice">Construir</button>
          <button class="btn" id="btnInvoicePDF">PDF</button>
        </div>
      </div>

      <div class="invoice" id="invoiceBox">
        <div class="muted">—</div>
      </div>
    </div>
  </section>

  <!-- ================= ADMIN SETTINGS ================= -->
  <section class="view" id="view-adminSettings">
    <div class="card">
      <div class="cardHead">
        <h2>Settings (Admin)</h2>
        <div class="hint">Se guardan en Firestore (settings/global)</div>
      </div>

      <div class="formGrid">
        <label>Marca / Nombre
          <input id="setBrand" placeholder="Nexus Transport PR"/>
        </label>

        <label>Connect %
          <input id="setConnect" type="number" step="0.01" inputmode="decimal" placeholder="0.15"/>
        </label>

        <label>Empresa %
          <input id="setCompany" type="number" step="0.01" inputmode="decimal" placeholder="0.30"/>
        </label>

        <label>Retención %
          <input id="setRetention" type="number" step="0.01" inputmode="decimal" placeholder="0.10"/>
        </label>

        <label class="full">Footer
          <input id="setFooter" placeholder="Resumen generado por Nexus Transport PR"/>
        </label>

        <div class="actions full">
          <button class="btn primary" id="btnSaveSettings">Guardar</button>
          <button class="btn" id="btnWipeCache">Limpiar cache local</button>
        </div>
      </div>

      <div class="muted" style="margin-top:10px">
        Nota: para seguridad real “enterprise”, lo ideal es Custom Claims. Hoy lo dejamos con verificación por doc users/{uid} (válido para este MVP PRO).
      </div>
    </div>
  </section>

</main>

<footer class="footer">
  © 2026 Nexus Transport PR
</footer>

<script src="app.js?v=200"></script>
</body>
</html>
