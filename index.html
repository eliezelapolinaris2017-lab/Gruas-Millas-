<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nexus Transport PR</title>

  <!-- Tu CSS -->
  <link rel="stylesheet" href="styles.css" />
</head>

<body>

  <!-- TOPBAR (solo visible cuando autenticado) -->
  <header class="topbar" id="topbar" hidden>
    <div class="brand">
      <div class="logo" aria-label="Logo">NT</div>
      <div>
        <div class="brandName" id="brandName">Nexus Transport PR</div>
        <div class="brandSub">
          <span id="whoLine">—</span>
          <span class="muted"> • </span>
          <span class="tab active" style="pointer-events:none; padding:6px 10px" id="rolePill">—</span>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="btnReload" type="button">Recargar</button>
      <button class="btn danger" id="btnLogout" type="button">Salir</button>
    </div>
  </header>

  <!-- APP WRAPPER (solo visible cuando autenticado) -->
  <main class="container" id="app" hidden>

    <!-- NAV TABS -->
    <nav class="nav" id="navTabs">
      <button class="tab active" type="button" data-view="dashboard">Dashboard</button>
      <button class="tab" type="button" data-view="driver">Mi Historial</button>

      <!-- Admin tabs (se esconden si no es admin) -->
      <button class="tab" type="button" data-view="adminUsers" id="tabAdminUsers">Usuarios</button>
      <button class="tab" type="button" data-view="adminClients" id="tabAdminClients">Clientes</button>
      <button class="tab" type="button" data-view="adminServices" id="tabAdminServices">Servicios</button>
      <button class="tab" type="button" data-view="adminClose" id="tabAdminClose">Cierre</button>
      <button class="tab" type="button" data-view="adminInvoices" id="tabAdminInvoices">Facturar</button>
      <button class="tab" type="button" data-view="adminSettings" id="tabAdminSettings">Settings</button>
    </nav>

    <!-- =========================
         VIEW: LOGIN + PIN
    ========================== -->
    <section class="view active" id="view-login">
      <div class="card">
        <div class="cardHead">
          <h2>Acceso</h2>
          <div class="hint" id="loginMsg">—</div>
        </div>

        <div class="inline2">
          <div class="card subcard">
            <div class="muted" style="margin-bottom:10px">
              1) Entra con Google (Firebase Auth).<br />
              2) Confirma tu PIN (o crea PIN si es primera vez).
            </div>

            <div class="actions">
              <button class="btnXL primary" id="btnGoogleLogin" type="button">Entrar con Google</button>
            </div>
          </div>

          <div class="card subcard">
            <h3 style="margin:0 0 10px 0">PIN</h3>

            <div class="formGrid">
              <label class="full">
                PIN (confirmar)
                <input id="pinInput" inputmode="numeric" placeholder="••••" />
              </label>
              <div class="full actions">
                <button class="btn primary" id="btnPinConfirm" type="button">Confirmar PIN</button>
                <span class="muted" id="pinError"></span>
              </div>

              <div class="full hr"></div>

              <label>
                PIN nuevo
                <input id="pinNew" inputmode="numeric" placeholder="Mínimo 4 dígitos" />
              </label>
              <label>
                Confirmar PIN
                <input id="pinNew2" inputmode="numeric" placeholder="Repite PIN" />
              </label>
              <div class="full actions">
                <button class="btn" id="btnPinSet" type="button">Guardar PIN</button>
                <span class="muted" id="pinSetError"></span>
              </div>
            </div>

          </div>
        </div>

      </div>
    </section>

    <!-- =========================
         VIEW: DASHBOARD
    ========================== -->
    <section class="view" id="view-dashboard">

      <div class="grid2">
        <div class="card">
          <div class="kpiTitle" id="kpiWeekRange">Semana desde —</div>
          <div class="kpiValue" id="kpiWeekMiles">0.0</div>
          <div class="kpiSub">Millas</div>
        </div>

        <div class="card">
          <div class="kpiTitle">Servicios</div>
          <div class="kpiValue" id="kpiWeekServices">0</div>
          <div class="kpiSub">Conteo semanal</div>
        </div>

        <div class="card">
          <div class="kpiTitle">Neto chofer</div>
          <div class="kpiValue" id="kpiWeekDriverNet">$0.00</div>
          <div class="kpiSub">Suma semanal (tu usuario)</div>
        </div>

        <div class="card">
          <div class="kpiTitle">Empresa</div>
          <div class="kpiValue" id="kpiWeekCompany">$0.00</div>
          <div class="kpiSub">Suma semanal</div>
        </div>
      </div>

      <div class="inline2">
        <!-- Quick Entry -->
        <div class="card">
          <div class="cardHead">
            <h2>Entrada rápida (solo millas)</h2>
            <div class="hint">Chofer escribe • Cliente dinámico • Cálculo automático</div>
          </div>

          <div class="formGrid">
            <label>
              Fecha
              <input type="date" id="qsDate" />
            </label>

            <label>
              Cliente
              <select id="qsClient"></select>
            </label>

            <label>
              Millas
              <input id="qsMiles" inputmode="decimal" placeholder="Ej: 12.5" />
            </label>

            <label class="full">
              Nota (opcional)
              <input id="qsNote" placeholder="Ej: Servicio nocturno / etc." />
            </label>

            <div class="full actions">
              <button class="btn primary" id="btnQuickSave" type="button">Guardar servicio</button>
              <button class="btn" id="btnQuickClear" type="button">Limpiar</button>
              <span class="muted" id="quickPreview">—</span>
            </div>
          </div>
        </div>

        <!-- Recent -->
        <div class="card">
          <div class="cardHead">
            <h2>Servicios recientes (semana)</h2>
            <div class="hint">Admin puede borrar • Chofer solo ve</div>
          </div>

          <div class="tableWrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Cliente</th>
                  <th class="num">Millas</th>
                  <th class="num">Bruto</th>
                  <th class="num">Neto chofer</th>
                  <th class="num">Acción</th>
                </tr>
              </thead>
              <tbody id="dashRecent"></tbody>
            </table>
          </div>
        </div>
      </div>

    </section>

    <!-- =========================
         VIEW: DRIVER HISTORY
    ========================== -->
    <section class="view" id="view-driver">
      <div class="card">
        <div class="cardHead">
          <h2>Mi historial</h2>
          <div class="hint">Agrupa por semana o mes • Exporta en PDF</div>
        </div>

        <div class="filters">
          <label>
            Desde
            <input type="date" id="drvFrom" />
          </label>

          <label>
            Hasta
            <input type="date" id="drvTo" />
          </label>

          <label>
            Agrupar
            <select id="drvGroup">
              <option value="none">Detalle</option>
              <option value="week">Por semana</option>
              <option value="month">Por mes</option>
            </select>
          </label>

          <div class="actions">
            <button class="btn primary" id="btnDrvFilter" type="button">Aplicar</button>
            <button class="btn" id="btnDrvPDF" type="button">PDF (jsPDF)</button>
          </div>
        </div>

        <div class="tableWrap">
          <table class="table">
            <thead id="drvHead"></thead>
            <tbody id="drvBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- =========================
         VIEW: ADMIN USERS
    ========================== -->
    <section class="view" id="view-adminUsers">
      <div class="card">
        <div class="cardHead">
          <h2>Usuarios (admin)</h2>
          <div class="hint">Invita por email • Reset PIN • Roles</div>
        </div>

        <div class="formGrid">
          <label>
            Email
            <input id="uEmail" placeholder="chofer@email.com" />
          </label>

          <label>
            Rol
            <select id="uRole">
              <option value="driver">driver</option>
              <option value="admin">admin</option>
            </select>
          </label>

          <label>
            Activo
            <select id="uActive">
              <option value="true">Sí</option>
              <option value="false">No</option>
            </select>
          </label>

          <label class="full">
            Nota
            <input id="uNote" placeholder="Ej: Turno noche / etc." />
          </label>

          <div class="full actions">
            <button class="btn primary" id="btnInviteUser" type="button">Guardar invitación</button>
            <button class="btn" id="btnResetPin" type="button">Reset PIN (seleccionado)</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="tableWrap">
          <table class="table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Rol</th>
                <th>Activo</th>
                <th>UID</th>
                <th>PIN</th>
                <th>Acción</th>
              </tr>
            </thead>
            <tbody id="usersTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- =========================
         VIEW: ADMIN CLIENTS
    ========================== -->
    <section class="view" id="view-adminClients">
      <div class="card">
        <div class="cardHead">
          <h2>Clientes (admin)</h2>
          <div class="hint">Clientes dinámicos • Tarifa por milla • Connect = ajuste -15%</div>
        </div>

        <div class="formGrid">
          <label>
            Nombre
            <input id="cName" placeholder="Ej: Connect / Dealer / Privado" />
          </label>

          <label>
            Tarifa ($/milla)
            <input id="cRate" inputmode="decimal" placeholder="Ej: 1.00" />
          </label>

          <label>
            ¿Es Connect?
            <select id="cConnect">
              <option value="no">No</option>
              <option value="yes">Sí</option>
            </select>
          </label>

          <label>
            Activo
            <select id="cActive">
              <option value="true">Sí</option>
              <option value="false">No</option>
            </select>
          </label>

          <div class="full actions">
            <button class="btn primary" id="btnSaveClient" type="button">Guardar</button>
            <button class="btn" id="btnClearClient" type="button">Limpiar</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="tableWrap">
          <table class="table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th class="num">Tarifa</th>
                <th>Connect</th>
                <th>Activo</th>
                <th>Acción</th>
              </tr>
            </thead>
            <tbody id="clientsTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- =========================
         VIEW: ADMIN SERVICES
    ========================== -->
    <section class="view" id="view-adminServices">
      <div class="card">
        <div class="cardHead">
          <h2>Servicios (admin)</h2>
          <div class="hint">Filtra • Export CSV • Borrar múltiple</div>
        </div>

        <div class="filters">
          <label>
            Semana (lunes)
            <input type="date" id="sWeek" />
          </label>

          <label>
            Chofer
            <select id="sDriver"></select>
          </label>

          <label>
            Cliente
            <select id="sClient"></select>
          </label>

          <div class="actions">
            <button class="btn primary" id="btnSvcFilter" type="button">Filtrar</button>
            <button class="btn" id="btnSvcCSV" type="button">CSV</button>
            <button class="btn danger" id="btnSvcDeleteMany" type="button">Borrar selección</button>
          </div>
        </div>

        <div class="tableWrap">
          <table class="table">
            <thead>
              <tr>
                <th></th>
                <th>Fecha</th>
                <th>Chofer</th>
                <th>Cliente</th>
                <th class="num">Millas</th>
                <th class="num">Bruto</th>
                <th class="num">Adj</th>
                <th class="num">Empresa</th>
                <th class="num">Ret.</th>
                <th class="num">Neto chofer</th>
                <th>Acción</th>
              </tr>
            </thead>
            <tbody id="servicesTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- =========================
         VIEW: ADMIN CLOSE
    ========================== -->
    <section class="view" id="view-adminClose">
      <div class="card">
        <div class="cardHead">
          <h2>Cierre semanal (admin)</h2>
          <div class="hint">Totales por chofer • PDF (jsPDF)</div>
        </div>

        <div class="filters">
          <label>
            Semana (lunes)
            <input type="date" id="wkStart" />
          </label>

          <label>
            Chofer
            <select id="wkDriver"></select>
          </label>

          <div class="actions">
            <button class="btn primary" id="btnBuildWeekly" type="button">Generar</button>
            <button class="btn" id="btnWeeklyPDF" type="button">PDF</button>
          </div>
        </div>

        <div class="invoice" id="weeklyBox">
          <div class="muted">—</div>
        </div>
      </div>
    </section>

    <!-- =========================
         VIEW: ADMIN INVOICES
    ========================== -->
    <section class="view" id="view-adminInvoices">
      <div class="card">
        <div class="cardHead">
          <h2>Factura por cliente (admin)</h2>
          <div class="hint">Semana • Cliente • PDF (jsPDF)</div>
        </div>

        <div class="filters">
          <label>
            Semana (lunes)
            <input type="date" id="invWeek" />
          </label>

          <label>
            Cliente
            <select id="invClient"></select>
          </label>

          <div class="actions">
            <button class="btn primary" id="btnBuildInvoice" type="button">Generar</button>
            <button class="btn" id="btnInvoicePDF" type="button">PDF</button>
          </div>
        </div>

        <div class="invoice" id="invoiceBox">
          <div class="muted">—</div>
        </div>
      </div>
    </section>

    <!-- =========================
         VIEW: ADMIN SETTINGS
    ========================== -->
    <section class="view" id="view-adminSettings">
      <div class="card">
        <div class="cardHead">
          <h2>Settings (admin)</h2>
          <div class="hint">Persistente en Firestore (settings/global)</div>
        </div>

        <div class="formGrid">
          <label class="full">
            Brand / Nombre
            <input id="setBrand" />
          </label>

          <label>
            Connect % (0.15)
            <input id="setConnect" inputmode="decimal" />
          </label>

          <label>
            Empresa % (0.30)
            <input id="setCompany" inputmode="decimal" />
          </label>

          <label>
            Retención % (0.10)
            <input id="setRetention" inputmode="decimal" />
          </label>

          <label class="full">
            Footer (PDF)
            <input id="setFooter" />
          </label>

          <div class="full actions">
            <button class="btn primary" id="btnSaveSettings" type="button">Guardar settings</button>
            <button class="btn" id="btnWipeCache" type="button">Limpiar cache local</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="muted">
          Nota operacional: chofer **solo escribe** y ve su historial. Admin ve todo.
        </div>
      </div>
    </section>

  </main>

  <footer class="footer">
    <div>© <span id="yearNow"></span> Nexus Transport PR</div>
  </footer>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- jsPDF (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- App -->
  <script src="app.js"></script>

  <script>
    document.getElementById("yearNow").textContent = new Date().getFullYear();
  </script>

</body>
</html>
